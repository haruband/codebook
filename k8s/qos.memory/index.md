쿠버네티스는 리눅스 커널이 제공하는 CGroupV2 기능을 이용하여 다양한 QoS 기능을 제공하고 있다.

- 새로운 메모리를 할당받는다. (익명 페이지 or 페이지 캐시)
- 현재 CGROUP 의 메모리 사용량을 확인한다.
- 메모리 초과 사용시, 초과된 메모리를 모두 반환한다.
- 메모리 반환 실패시, 해당 프로세스는 종료된다.

## _페이지 캐시는 누구의 소유인가?_

스택과 힙에 사용되는 익명 페이지는 해당 프로세스의 소유이지만, 페이지 캐시는 누구나 사용할 수 있기 때문에 어떤 프로세스의 소유인지가 애매하다. 커널은 간단히 페이지 캐시를 처음 접근해서 페이지를 할당한 프로세스의 소유로 한다. 그래서 여러 군데서 사용되는 페이지 캐시를 소유할 수록 불리하다. 왜냐하면 다른 프로세스도 사용하는데 해당 프로세스의 메모리 사용량만 줄어들기 때문이다.

## _주의해야할 사항_

높은 우선순위를 가진 Pod 도 커널에 의해 종료될 수 있다. 전체 메모리가 부족해서 실행되는 커널이나 쿠버네티스의 OOM 에 의해 종료되진 않겠지만, 메모리 한도까지 익명 페이지를 사용한다면. 최근 쿠버네티스에 추가된 스왑 기능을 이용하면 개선할 수 있다.

높은 우선순위를 가진 Pod 이 낮은 우선순위를 가진 Pod 에 의해 방해받을 수 있다. 커널은 메모리가 부족해지면 메모리를 반환하기 시작하는데 이때 루트 CGROUP 부터 PRE-ORDER 방식으로 순회하면서 LRU 리스트를 뒤지면서 반환하기 때문에 우선순위가 높은 Pod 의 자주 사용하지 않는 페이지가 반환될 수 있다.
