대부분의 SQL 엔진에서 성능 향상을 위해 가장 많이 신경쓰는 부분은 바로 조인(Join)일 것이다. 다양한 조건의 조인을 처리하기 위해 여러 가지 동작 방식이 존재하며, 오늘은 Datafusion 에서 어떤 방식으로 조인을 처리하는지, 어떤 방법으로 최적화하는지 살펴보도록 하자.

대부분 가장 좋은 성능을 보여주는 방식은 HashJoin 이다. 이는 아래 그림처럼 작은 테이블을 이용하여 해시 테이블을 먼저 만들고, 큰 테이블을 순서대로 비교하면서 처리하는 방식이다. 해시를 이용하기 때문에 큰 테이블에 있는 데이터가 작은 테이블에 있는지 비교하는 비용은 O(1) 이지만, 해시 테이블을 메모리에 유지하는 비용이 문제가 될 수 있다. 그래서 해시 테이블의 크기가 작다면 하나의 해시 테이블을 만드는 방식(Broadcast)을 사용하고, 해시 테이블의 크기가 크다면 등가(Equal) 조건 컬럼으로 파티셔닝한 다음 해시 테이블을 만드는 방식(Shuffle)을 사용한다.

![join2.png](./join2.png)

![join1.png](./join1.png)

![join0.png](./join0.png)

![join.strategies.png](./join.strategies.png)
