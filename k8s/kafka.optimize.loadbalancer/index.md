쿠버네티스(K8S) 환경에서 대표적인 오픈소스 로드밸런서(LoadBalancer)인 [MetalLB](https://metallb.universe.tf/) 를 이용하여 카프카(Kafka)의 네트워크 성능을 최적화한 사례를 공유하고자 한다. 우리는 [StrimziOperator](https://strimzi.io/) 를 이용하여 카프카를 배포/운영하고 있으며, 초기에는 간단히 노드포트(NodePort)를 이용하여 부트스트랩(Bootstrap)과 브로커(Broker)에 접근했기 때문에 불필요한 네트워크 홉(Hop)이 추가되는 문제가 발생하였다. 우선, 간단히 노드포트가 어떻게 동작하기에 이런 문제가 생긴 것인지 알아보도록 하자.

![cilium.nodeport](./cilium-nodeport.png)

위의 그림은 클라이언트가 노드포트를 이용하여 서비스에 접근하는 과정이다. 노드포트는 모든 노드에서 사용할 수 있고, 클라이언트는 해당 서비스의 엔드포인트(Pod3)가 어느 노드에 있는지 알 수 없기 때문에 임의의 노드(위에서는 Node0)로 접속한다. 위의 경우에는 엔드포인트가 Node1 에 있었기 때문에, Node0 에서 SNAT 기법을 이용하여 Node1 로 요청 메세지를 송신하고 응답 메세지를 수신한 다음 클라이언트에게 전달한다. 이는 클라이언트가 처음부터 엔드포인트가 있는 노드(Node1)로 바로 접속했으면 발생하지 않았을 문제이기 때문에, 쿠버네티스가 제공하는 로드밸런서를 이용하면 간단히 해결할 수 있다.
