오늘은 Istio 에서 공개한 AmbientMesh 의 동작 과정을 분석해보도록 하겠다. 성능이나 확장성 면에서 우수한 eBPF 모드를 기준으로 설명할 계획이며, CNI 는 Calico(+IPTables)를 사용하였다.

아래 그림은 출발지 파드(jupyterlab)에서 목적지 파드(nginx)로 패킷이 전달되는 과정을 보여주고 있다. (출발지 파드에서는 목적지 서비스(nginx)의 주소(172.16.52.69)로 접속하였다.) 목적지 파드는 프록시(Waypoint)가 설치된 네임스페이스(default)에 속해있기 때문에 패킷은 해당 프록시를 통해서 전달된다. 설명은 패킷이 전달되는 순서대로(그림에 표시된 1~8번까지의 숫자) 진행하도록 하겠다.

![istio.ambientmesh.flow](./istio-ambientmesh-flow.png)

1번은 출발지 파드에서 패킷이 송신되는 단계이다. 패킷의 출발지 물리주소(4e:c8:60:12:7b:5b)는 출발지 파드(juypterlab)의 네트워크 장치(eth0)의 주소이고, 목적지 물리주소(ee:ee:ee:ee:ee:ee)는 출발지 파드의 호스트 네트워크 장치(veth0)의 주소이다. 그리고 패킷의 네트워크 주소는 출발지 파드(10.69.11.36)와 목적지 서비스(172.16.52.69)의 주소이다.

```
# packet header in 1 step
4e:c8:60:12:7b:5b > ee:ee:ee:ee:ee:ee,
10.69.11.36.60348 > 172.16.52.69.80: ...
```

출발지 파드의 네트워크 장치(eth0)를 통해 송신된 패킷은 VETH 로 연결된 호스트 네트워크 장치(veth0)로 전달되고, 호스트 네트워크 장치(veth0)의 ingress BPF 프로그램(A)에서는 패킷의 목적지 물리주소를 터널링 파드(ztunnel0)의 네트워크 장치(eth1)의 물리주소(3e:53:50:ac:00:d4)로 수정한 다음, 강제로 터널링 파드의 호스트 네트워크 장치(veth1)로 전달한다. 그리고 호스트 네트워크 장치(veth1)로 전달된 패킷은 VETH 로 연결된 네트워크 장치(eth1)로 전달된다.

2번은 터널링 파드에서 패킷이 수신되는 단계이다. 수신된 패킷은 네트워크 장치(eth1)의 ingress BPF 프로그램(B)에서 TPROXY 방식으로 Ztunnel 이 15001 번 포트로 대기(listen)하고 있는 소켓으로 전달한다. 이 때 생성(accept)되는 소켓의 로컬 주소는 TPROXY 방식을 사용했기 때문에 터널링 파드의 주소가 아닌 목적지 서비스(172.16.52.69)의 주소이다.

```
# packet header in 2 step
4e:c8:60:12:7b:5b > 3e:53:50:ac:00:d4,
10.69.11.36.60348 > 172.16.52.69.80: ...
```

```
# packet header in 3 step
3e:53:50:ac:00:d4 > ee:ee:ee:ee:ee:ee,
10.69.11.36.60157 > 10.69.149.2.15008: ...
```

```
# packet header in 4 step
ee:ee:ee:ee:ee:ee > 0a:20:6d:71:01:f7,
10.69.11.36.60157 > 10.69.149.2.15008: ...
```

```
# packet header in 5 step
0a:20:6d:71:01:f7 > ee:ee:ee:ee:ee:ee,
10.69.149.2.59990 > 10.88.135.163.15008: ...
```

```
# packet header in 6 step
ee:ee:ee:ee:ee:ee > ce:7f:ba:06:21:08,
10.69.149.2.59990 > 10.88.135.163.15008: ...
```

```
# packet header in 7 step
ce:7f:ba:06:21:08 > ee:ee:ee:ee:ee:ee,
10.69.149.2.34621 > 10.88.135.163.80: ...
```

```
# packet header in 8 step
ce:7f:ba:06:21:08 > ba:02:f4:c8:98:77,
10.69.149.2.34621 > 10.88.135.163.80: ...
```
